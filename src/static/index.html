<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/Video-Download.png">
</head>
<body>
    <div id="root"></div>
    <script src="/api/constants.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const GC = window.GENERAL_CONSTANTS || { DEFAULTS: {}, STRINGS: {} };

        function RssTransmissionManager() {
            const [feeds, setFeeds] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showForm, setShowForm] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [editing, setEditing] = useState(null);
            const [form, setForm] = useState({ name: '', url: '', pt_site: (GC.LISTS?.PT_SITES?.[0]) || '', key_words: '', path: '', set_default_download: false, interval: GC.DEFAULTS.DEFAULT_RSS_INTERVAL || 10, enabled: true });
            const [settings, setSettings] = useState({ 
                transmission_url: GC.DEFAULTS.TRANSMISSION_URL || '', 
                transmission_port: GC.DEFAULTS.TRANSMISSION_PORT || 9091,
                username: '', 
                password: '', 
                default_rss_interval: GC.DEFAULTS.DEFAULT_RSS_INTERVAL || 10 
            });
            const [settingsErrors, setSettingsErrors] = useState({});
            const [selectedLogs, setSelectedLogs] = useState([]);
            const [logFeed, setLogFeed] = useState(null);
            const [toast, setToast] = useState(null);
            const pollRef = useRef(null);

            useEffect(() => { 
                // set page title from constants
                document.title = GC.STRINGS.TITLE || document.title;
                fetchFeeds(); 
                fetchSettings();
                startPollingStatus(); 
                return stopPollingStatus; 
            }, []);

            function startPollingStatus(){
                pollRef.current = setInterval(()=>{
                    fetchFeeds(true); // Refresh feeds silently
                }, GC.DEFAULTS.AUTO_REFRESH_MS || 15000);
            }
            function stopPollingStatus(){ if(pollRef.current) clearInterval(pollRef.current); }

            async function fetchFeeds(silent = false){
                if (!silent) setLoading(true);
                try{
                    const res = await fetch('/api/feeds', {
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if(!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    setFeeds(data);
                }catch(e){ 
                    console.error(e); 
                    if (!silent) showToast(`${GC.STRINGS.FAILED_LOAD_FEEDS}: ${e.message}`, 'error'); 
                }
                if (!silent) setLoading(false);
            }

            function showToast(msg, type='info'){ setToast({msg,type}); setTimeout(()=>setToast(null),4000); }

            async function fetchSettings(){
                try{
                    const res = await fetch('/api/settings');
                    if(!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    setSettings(data);
                }catch(e){ console.error(e); }
            }

            function validateSettings(){
                const errors = {};
                if(!Number.isInteger(Number(settings.transmission_port)) || Number(settings.transmission_port) < 1 || Number(settings.transmission_port) > 65535){
                    errors.transmission_port = 'Port必须为1-65535之间的整数';
                }
                if(settings.default_rss_interval < 5){
                    errors.default_rss_interval = 'RSS间隔至少为5分钟';
                }
                if(settings.default_rss_interval > 1440){
                    errors.default_rss_interval = 'RSS间隔不能超过1440分钟（24小时）';
                }
                setSettingsErrors(errors);
                return Object.keys(errors).length === 0;
            }

            async function saveSettings(e){
                e.preventDefault();
                if(!validateSettings()) {
                    showToast(GC.STRINGS.FIX_ERRORS, 'error');
                    return;
                }
                try{
                    const res = await fetch('/api/settings', {
                        method: 'POST', 
                        headers: {'content-type': 'application/json'}, 
                        body: JSON.stringify(settings)
                    });
                    if(!res.ok) {
                        const errorData = await res.json();
                        throw new Error(errorData.detail || await res.text());
                    }
                    showToast(GC.STRINGS.SETTINGS_SAVED, 'success');
                    setShowSettings(false);
                    // 重新获取feeds以应用新的默认间隔
                    await fetchFeeds();
                }catch(e){ 
                    showToast(`${GC.STRINGS.SAVE_FAILED}: ${e.message}`, 'error'); 
                }
            }

            function openNew(){ 
                setEditing(null); 
                // default checkbox: checked if no default_download_path exists
                const shouldCheck = !settings.default_download_path || settings.default_download_path === '';
                setForm({name:'',url:'',pt_site:(GC.LISTS?.PT_SITES?.[0]) || '', key_words:'', path:'', set_default_download: shouldCheck, interval:settings.default_rss_interval || 10,enabled:true}); 
                setShowForm(true); 
            }
            function openEdit(f){ setEditing(f); const shouldCheck = !settings.default_download_path || settings.default_download_path === ''; setForm({name:f.name,url:f.url,pt_site:f.pt_site || ((GC.LISTS?.PT_SITES?.[0]) || ''), key_words: f.key_words || '', path:f.path||'', set_default_download: shouldCheck, interval:f.interval,enabled:!!f.enabled}); setShowForm(true); }

            async function submitForm(e){
                e.preventDefault();
                try{
                    const method = editing ? 'PUT' : 'POST';
                    const url = editing ? `/api/feeds/${editing.id}` : '/api/feeds';
                    const res = await fetch(url, {method, headers:{'content-type':'application/json'}, body: JSON.stringify(form)});
                    if(!res.ok) {
                        const errorData = await res.json().catch(async () => ({detail: await res.text()}));
                        throw new Error(errorData.detail || '保存失败');
                    }
                    await fetchFeeds();
                    setShowForm(false);
                    showToast(editing ? GC.STRINGS.FEED_UPDATED : GC.STRINGS.FEED_ADDED,'success');
                }catch(e){ 
                    showToast(`${GC.STRINGS.SAVE_FAILED}: ${e.message}`,'error'); 
                }
            }

            async function removeFeed(id){ if(!confirm(GC.STRINGS.CONFIRM_DELETE)) return; try{ const res = await fetch(`/api/feeds/${id}`,{method:'DELETE'}); if(!res.ok) throw new Error(await res.text()); await fetchFeeds(); showToast(GC.STRINGS.DELETED,'success'); }catch(e){ showToast(`${GC.STRINGS.DELETE_FAILED}: ${e.message}`,'error'); } }

            async function triggerCheck(id){ try{ const res = await fetch(`/api/feeds/${id}/check`,{method:'POST'}); if(!res.ok) throw new Error(await res.text()); const data = await res.json(); showToast(`${GC.STRINGS.CHECK_DONE}: ${data.newItems?.length || 0}`,'success'); await fetchFeeds(); }catch(e){ showToast(`${GC.STRINGS.CHECK_FAILED}: ${e.message}`,'error'); } }

            async function openLogs(id){ setLogFeed(id); try{ const res = await fetch(`/api/feeds/${id}/logs`); if(!res.ok) throw new Error(await res.text()); const data = await res.json(); setSelectedLogs(data); }catch(e){ showToast(`${GC.STRINGS.LOAD_LOGS_FAILED}: ${e.message}`,'error'); } }

            async function sendToTransmission(id, item){
                try{
                    const payload = { itemId: item.id };
                    const res = await fetch(`/api/feeds/${id}/send`,{method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                    if(!res.ok) throw new Error(await res.text());
                    showToast(GC.STRINGS.SENT_TO_TRANSMISSION,'success');
                    await fetchFeeds();
                }catch(e){ showToast('Send failed: '+e.message,'error'); }
            }

            return (
                <div className="p-6 max-w-6xl mx-auto">
                    <div className="flex items-center justify-between mb-6">
                        <h1 className="text-2xl font-bold">{GC.STRINGS.TITLE}</h1>
                        <div className="flex gap-2">
                            <button onClick={()=>setShowSettings(true)} className="px-3 py-1 border rounded">{GC.STRINGS.SETTINGS}</button>
                            <button onClick={openNew} className="px-3 py-1 bg-sky-600 text-white rounded shadow">{GC.STRINGS.ADD_FEED}</button>
                            <button onClick={fetchFeeds} className="px-3 py-1 border rounded">{GC.STRINGS.REFRESH}</button>
                        </div>
                    </div>

                    <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div className="col-span-2">
                            <div className="bg-white rounded shadow border border-gray-200 p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h2 className="font-semibold">{GC.STRINGS.FEEDS_HEADER}</h2>
                                    <div className="text-sm text-slate-500">{GC.STRINGS.AUTO_REFRESH_MSG}</div>
                                </div>
                                {loading ? <div>Loading...</div> : (
                                    <div className="space-y-3">
                                        {feeds.length === 0 && <div className="text-slate-500">{GC.STRINGS.NO_FEEDS}</div>}
                                        {feeds.map(feed => (
                                            <div key={feed.id} className="border border-gray-300 rounded p-3 flex items-start justify-between">
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-3 flex-wrap">
                                                        <div className={`text-xs px-2 py-1 rounded ${feed.enabled? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{feed.enabled? 'ENABLED':'DISABLED'}</div>
                                                        <div className="font-medium">{feed.name}</div>
                                                        <div className="text-xs text-slate-500 truncate max-w-md" title={feed.url}>{feed.url}</div>
                                                    </div>
                                                    <div className="text-sm text-slate-600 mt-2">Interval: {feed.interval} min · Last check: {feed.lastChecked || '—'} · Status: {feed.lastStatus || '—'}</div>
                                                </div>
                                                <div className="flex flex-col gap-2 ml-4">
                                                    <button onClick={()=>openEdit(feed)} className="px-2 py-1 border rounded">Edit</button>
                                                    <button onClick={()=>triggerCheck(feed.id)} className="px-2 py-1 bg-amber-500 text-white rounded">Check</button>
                                                    <button onClick={()=>openLogs(feed.id)} className="px-2 py-1 border rounded">Logs</button>
                                                    <button onClick={()=>removeFeed(feed.id)} className="px-2 py-1 bg-red-600 text-white rounded">Delete</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="bg-white rounded shadow border border-gray-200 p-4 mt-4">
                                <h2 className="font-semibold mb-2">Recent Activity</h2>
                                <div className="text-sm text-slate-600">List of recent events will be shown here (backend should supply aggregated events endpoint if desired).</div>
                            </div>
                        </div>

                    </section>

                    {showForm && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center">
                            <form onSubmit={submitForm} className="bg-white rounded p-6 w-full max-w-md shadow">
                                <h3 className="text-lg font-semibold mb-4">{editing? GC.STRINGS.BTN_EDIT : GC.STRINGS.ADD_FEED}</h3>
                                <label className="block text-sm mb-1">{GC.STRINGS.NAME_LABEL}</label>
                                <input required className="w-full border rounded px-2 py-1 mb-3" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                <label className="block text-sm mb-1">PT Site</label>
                                <select className="w-full border rounded px-2 py-1 mb-3" value={form.pt_site} onChange={e=>setForm({...form, pt_site: e.target.value})}>
                                    {(GC.LISTS?.PT_SITES || []).map((s,idx)=> (<option key={idx} value={s}>{s}</option>))}
                                </select>
                                <label className="block text-sm mb-1">{GC.STRINGS.RSS_URL_LABEL}</label>
                                <input required className="w-full border rounded px-2 py-1 mb-3" value={form.url} onChange={e=>setForm({...form, url:e.target.value})} />
                                <label className="block text-sm mb-1">Keywords</label>
                                <input className="w-full border rounded px-2 py-1 mb-3" value={form.key_words} onChange={e=>setForm({...form, key_words: e.target.value})} placeholder="keywords, separated by spaces (optional)" />
                                <label className="block text-sm mb-1">{GC.STRINGS.PATH_LABEL}</label>
                                <input className="w-full border rounded px-2 py-1 mb-1" value={form.path} onChange={e=>setForm({...form, path: e.target.value})} placeholder={GC.STRINGS.PLACEHOLDER_PATH} />
                                {settings.default_download_path && settings.default_download_path !== '' && (
                                    <div className="text-xs text-slate-500 mb-2">默认下载路径: {settings.default_download_path}</div>
                                )}
                                <label className="inline-flex items-center gap-2 mb-3"><input type="checkbox" checked={form.set_default_download} onChange={e=>setForm({...form, set_default_download: e.target.checked})} /> 将此路径设为默认下载路径</label>
                                <label className="block text-sm mb-1">{GC.STRINGS.INTERVAL_LABEL}</label>
                                <input type="number" min={1} className="w-full border rounded px-2 py-1 mb-3" value={form.interval} onChange={e=>setForm({...form, interval: Number(e.target.value)})} />
                                <label className="inline-flex items-center gap-2 mb-3"><input type="checkbox" checked={form.enabled} onChange={e=>setForm({...form, enabled: e.target.checked})} /> {GC.STRINGS.ENABLED_LABEL}</label>
                                <div className="flex gap-2 justify-end">
                                    <button type="button" onClick={()=>setShowForm(false)} className="px-3 py-1 border rounded">{GC.STRINGS.CANCEL_BUTTON}</button>
                                    <button type="submit" className="px-3 py-1 bg-sky-600 text-white rounded">{GC.STRINGS.SAVE_BUTTON}</button>
                                </div>
                            </form>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-6">
                            <form onSubmit={saveSettings} className="bg-white rounded p-6 w-full max-w-md shadow">
                                <h3 className="text-lg font-semibold mb-4">{GC.STRINGS.SETTINGS}</h3>
                                
                                <div className="mb-4 grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm mb-1 font-medium">{GC.STRINGS.TRANSMISSION_RPC_LABEL}</label>
                                        <input 
                                            type="text"
                                            className={`w-full border rounded px-2 py-1 ${settingsErrors.transmission_url ? 'border-red-500' : ''}`}
                                            value={settings.transmission_url} 
                                            onChange={e=>{setSettings({...settings, transmission_url: e.target.value}); setSettingsErrors({...settingsErrors, transmission_url: null});}}
                                            placeholder={GC.STRINGS.PLACEHOLDER_TRANS_URL} 
                                        />
                                        {settingsErrors.transmission_url && <div className="text-xs text-red-500 mt-1">{settingsErrors.transmission_url}</div>}
                                    </div>
                                    <div>
                                        <label className="block text-sm mb-1 font-medium">{GC.STRINGS.TRANSMISSION_PORT_LABEL}</label>
                                        <input 
                                            type="number"
                                            min="1"
                                            max="65535"
                                            className="w-full border rounded px-2 py-1"
                                            value={settings.transmission_port} 
                                            onChange={e=>setSettings({...settings, transmission_port: e.target.value})}
                                            placeholder={`${GC.DEFAULTS.TRANSMISSION_PORT}`} 
                                        />
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm mb-1 font-medium">{GC.STRINGS.USERNAME_LABEL}</label>
                                    <input 
                                        type="text"
                                        className="w-full border rounded px-2 py-1"
                                        value={settings.username} 
                                        onChange={e=>setSettings({...settings, username: e.target.value})}
                                        placeholder="可选" 
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm mb-1 font-medium">{GC.STRINGS.PASSWORD_LABEL}</label>
                                    <input 
                                        type="password"
                                        className="w-full border rounded px-2 py-1"
                                        value={settings.password} 
                                        onChange={e=>setSettings({...settings, password: e.target.value})}
                                        placeholder="可选" 
                                    />
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm mb-1 font-medium">{GC.STRINGS.DEFAULT_RSS_INTERVAL_LABEL}</label>
                                    <input 
                                        type="number"
                                        min="5"
                                        max="1440"
                                        className={`w-full border rounded px-2 py-1 ${settingsErrors.default_rss_interval ? 'border-red-500' : ''}`}
                                        value={settings.default_rss_interval} 
                                        onChange={e=>{setSettings({...settings, default_rss_interval: Number(e.target.value)}); setSettingsErrors({...settingsErrors, default_rss_interval: null});}}
                                    />
                                    {settingsErrors.default_rss_interval && <div className="text-xs text-red-500 mt-1">{settingsErrors.default_rss_interval}</div>}
                                    <div className="text-xs text-slate-500 mt-1">新建RSS时将使用此默认间隔</div>
                                </div>

                                <div className="flex gap-2 justify-end">
                                    <button type="button" onClick={()=>{setShowSettings(false); setSettingsErrors({}); fetchSettings();}} className="px-3 py-1 border rounded">取消</button>
                                    <button type="submit" className="px-3 py-1 bg-sky-600 text-white rounded">保存</button>
                                </div>
                            </form>
                        </div>
                    )}

                    {logFeed && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-6">
                            <div className="bg-white rounded shadow w-full max-w-3xl max-h-[80vh] overflow-auto">
                                <div className="p-4 border-b flex items-center justify-between">
                                    <h4 className="font-semibold">Logs for feed {logFeed}</h4>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{ setLogFeed(null); setSelectedLogs([]); }} className="px-2 py-1 border rounded">{GC.STRINGS.BTN_CLOSE}</button>
                                        <button onClick={()=>{ navigator.clipboard.writeText(JSON.stringify(selectedLogs, null, 2)); showToast(GC.STRINGS.TOAST_COPIED,'success'); }} className="px-2 py-1 border rounded">{GC.STRINGS.BTN_COPY}</button>
                                    </div>
                                </div>
                                <div className="p-4 text-sm font-mono">
                                    {selectedLogs.length===0 && <div className="text-slate-500">{GC.STRINGS.LOGS_NO}</div>}
                                    {selectedLogs.map((l,idx)=> (
                                        <div key={idx} className="py-1 border-b">
                                            <div className="text-xs text-slate-400">{l.ts}</div>
                                            <div className="text-sm">[{l.level}] {l.msg}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && (
                        <div className={`fixed right-6 bottom-6 px-4 py-2 rounded shadow ${toast.type==='error'? 'bg-red-600 text-white' : toast.type==='success'? 'bg-green-600 text-white' : 'bg-slate-800 text-white'}`}>
                            {toast.msg}
                        </div>
                    )}
                </div>
            );
        }

        // 检查React是否加载
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
            document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">Error: React libraries failed to load. Please check your internet connection.</div>';
        } else {
            try {
                // 使用React 18的createRoot API，如果失败则使用旧版API
                if (ReactDOM.createRoot) {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(<RssTransmissionManager />);
                } else {
                    // 后备方案：使用React 17的render API
                    ReactDOM.render(<RssTransmissionManager />, document.getElementById('root'));
                }
            } catch (error) {
                console.error('React rendering error:', error);
                document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">Error rendering React component: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>

